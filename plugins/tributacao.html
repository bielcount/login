<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tributação</title>
    <style>
        /* Estilos específicos para o módulo de tributação */
        .tributacao-container {
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
        }

        .dashboard {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 200px;
            transition: height 0.3s ease-in-out;
            height: 100px;
            cursor: pointer;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .card.expanded {
            height: auto;
            justify-content: flex-start;
            cursor: default;
        }

        .card .content {
            display: none;
            width: 100%;
            text-align: left;
            margin-top: 10px;
        }

        .card.expanded .content {
            display: block;
        }

        .description {
            font-size: 14px;
            margin: 10px 0;
            color: var(--text-color);
            opacity: 0.7;
        }

        .input-field {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            width: 100%;
            background: var(--input-bg);
            margin-top: 10px;
            color: var(--input-text-color);
        }

        .readonly-field {
            background: var(--readonly-bg);
            color: var(--readonly-text-color);
            cursor: not-allowed;
        }

        .search-button {
            padding: 10px;
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            position: relative;
        }

        .search-button.loading .spinner {
            display: inline-block;
        }

        .search-button.loading span {
            display: none;
        }

        .spinner {
            display: none;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--icon-color);
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="tributacao-container">
        <h3>Módulo de Tributação</h3>
        <div class="dashboard">
            <!-- CFOP -->
            <div class="card" data-modulo="cfop">
                <div class="card-title">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <h3>CFOP</h3>
                </div>
                <p class="description">Código Fiscal de Operações e Prestações</p>
                <div class="content">
                    <input type="text" class="input-field" id="cfop-code" placeholder="Digite o código CFOP">
                    <input type="text" class="input-field readonly-field" id="cfop-description" placeholder="Descrição" readonly>
                    <input type="text" class="input-field readonly-field" id="cfop-type" placeholder="Tipo" readonly>
                    <button class="search-button" data-action="searchCFOP">Consultar</button>
                </div>
            </div>

            <!-- CST -->
            <div class="card" data-modulo="cst">
                <div class="card-title">
                    <i class="fas fa-calculator"></i>
                    <h3>CST</h3>
                </div>
                <p class="description">Código de Situação Tributária</p>
                <div class="content">
                    <input type="text" class="input-field" id="cst-code" placeholder="Digite o código CST">
                    <input type="text" class="input-field readonly-field" id="cst-description" placeholder="Descrição" readonly>
                    <input type="text" class="input-field readonly-field" id="cst-type" placeholder="Tipo" readonly>
                    <button class="search-button" data-action="searchCST">Consultar</button>
                </div>
            </div>

            <!-- CSOSN -->
            <div class="card" data-modulo="csosn">
                <div class="card-title">
                    <i class="fas fa-balance-scale"></i>
                    <h3>CSOSN</h3>
                </div>
                <p class="description">Código de Situação da Operação no Simples Nacional</p>
                <div class="content">
                    <input type="text" class="input-field" id="csosn-code" placeholder="Digite o código CSOSN">
                    <input type="text" class="input-field readonly-field" id="csosn-description" placeholder="Descrição" readonly>
                    <input type="text" class="input-field readonly-field" id="csosn-type" placeholder="Tipo" readonly>
                    <button class="search-button" data-action="searchCSOSN">Consultar</button>
                </div>
            </div>

            <!-- NCM -->
            <div class="card" data-modulo="ncm">
                <div class="card-title">
                    <i class="fas fa-barcode"></i>
                    <h3>NCM</h3>
                </div>
                <p class="description">Nomenclatura Comum do Mercosul</p>
                <div class="content">
                    <input type="text" class="input-field" id="ncm-code" placeholder="Digite o código NCM">
                    <input type="text" class="input-field readonly-field" id="ncm-descricao" placeholder="Descrição" readonly>
                    <input type="text" class="input-field readonly-field" id="ncm-ano-ato-ini" placeholder="Ano do Ato Inicial" readonly>
                    <input type="text" class="input-field readonly-field" id="ncm-numero-ato-ini" placeholder="Número do Ato Inicial" readonly>
                    <input type="text" class="input-field readonly-field" id="ncm-tipo-ato-ini" placeholder="Tipo do Ato Inicial" readonly>
                    <input type="text" class="input-field readonly-field" id="ncm-data-inicio" placeholder="Data de Início" readonly>
                    <input type="text" class="input-field readonly-field" id="ncm-data-fim" placeholder="Data de Fim" readonly>
                    <button class="search-button" data-action="searchNCM">
                        <i class="fas fa-spinner spinner"></i>
                        <span>Consultar</span>
                    </button>
                </div>
            </div>

            <!-- CNPJ -->
            <div class="card" data-modulo="cnpj">
                <div class="card-title">
                    <i class="fas fa-building"></i>
                    <h3>CNPJ</h3>
                </div>
                <p class="description">Cadastro Nacional da Pessoa Jurídica</p>
                <div class="content">
                    <input type="text" class="input-field" id="cnpj-code" placeholder="Digite o CNPJ">
                    <input type="text" class="input-field readonly-field" id="cnpj-fantasia" placeholder="Nome Fantasia" readonly>
                    <input type="text" class="input-field readonly-field" id="cnpj-razao-social" placeholder="Razão Social" readonly>
                    <input type="text" class="input-field readonly-field" id="cnpj-capital-social" placeholder="Capital Social" readonly>
                    <input type="text" class="input-field readonly-field" id="cnpj-abertura" placeholder="Data de Abertura" readonly>
                    <input type="text" class="input-field readonly-field" id="cnpj-telefone" placeholder="Telefone" readonly>
                    <input type="text" class="input-field readonly-field" id="cnpj-atividade-principal" placeholder="Atividade Principal" readonly>
                    <input type="text" class="input-field readonly-field" id="cnpj-email" placeholder="Email" readonly>
                    <input type="text" class="input-field readonly-field" id="cnpj-endereco" placeholder="Endereço" readonly>
                    <button class="search-button" data-action="searchCNPJ">Consultar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            // Função para carregar o cache do localStorage
            function carregarCache() {
                const cache = localStorage.getItem('tributacaoCache');
                return cache ? JSON.parse(cache) : {
                    cfop: {},
                    cst: {},
                    csosn: {},
                    ncm: {},
                    cnpj: {}
                };
            }

            // Função para salvar o cache no localStorage
            function salvarCache(cache) {
                localStorage.setItem('tributacaoCache', JSON.stringify(cache));
            }

            // Cache inicial
            let cache = carregarCache();

            // Função para expandir os cards
            function expandCard(event, selectedCard) {
                if (event.target.tagName === "INPUT" || event.target.tagName === "BUTTON") {
                    event.stopPropagation();
                    return;
                }

                document.querySelectorAll('.card').forEach(card => {
                    if (card !== selectedCard) {
                        card.classList.remove('expanded');
                    }
                });

                selectedCard.classList.toggle('expanded');
            }

            // Função para consultar CFOP
            async function searchCFOP(event) {
                event.stopPropagation();
                const code = document.getElementById('cfop-code').value;
                if (!code) return;

                if (cache.cfop[code]) {
                    document.getElementById('cfop-description').value = cache.cfop[code].descricao || 'Não encontrado';
                    document.getElementById('cfop-type').value = cache.cfop[code].tipo || 'Não encontrado';
                    return;
                }

                try {
                    const response = await fetch(`https://apidadostributarios.onrender.com/api/cfop/${code}`);
                    const data = await response.json();
                    cache.cfop[code] = data;
                    salvarCache(cache); // Salva o cache atualizado

                    document.getElementById('cfop-description').value = data.descricao || 'Não encontrado';
                    document.getElementById('cfop-type').value = data.tipo || 'Não encontrado';
                } catch (error) {
                    console.error('Erro ao buscar CFOP:', error);
                    document.getElementById('cfop-description').value = 'Erro ao buscar';
                    document.getElementById('cfop-type').value = 'Erro ao buscar';
                }
            }

            // Função para consultar CST
            async function searchCST(event) {
                event.stopPropagation();
                const code = document.getElementById('cst-code').value;
                if (!code) return;

                if (cache.cst[code]) {
                    document.getElementById('cst-description').value = cache.cst[code].descricao || 'Não encontrado';
                    document.getElementById('cst-type').value = cache.cst[code].tipo || 'Não encontrado';
                    return;
                }

                try {
                    const response = await fetch(`https://apidadostributarios.onrender.com/api/cst/${code}`);
                    const data = await response.json();
                    cache.cst[code] = data;
                    salvarCache(cache); // Salva o cache atualizado

                    document.getElementById('cst-description').value = data.descricao || 'Não encontrado';
                    document.getElementById('cst-type').value = data.tipo || 'Não encontrado';
                } catch (error) {
                    console.error('Erro ao buscar CST:', error);
                    document.getElementById('cst-description').value = 'Erro ao buscar';
                    document.getElementById('cst-type').value = 'Erro ao buscar';
                }
            }

            // Função para consultar CSOSN
            async function searchCSOSN(event) {
                event.stopPropagation();
                const code = document.getElementById('csosn-code').value;
                if (!code) return;

                if (cache.csosn[code]) {
                    document.getElementById('csosn-description').value = cache.csosn[code].descricao || 'Não encontrado';
                    document.getElementById('csosn-type').value = cache.csosn[code].tipo || 'Não encontrado';
                    return;
                }

                try {
                    const response = await fetch(`https://apidadostributarios.onrender.com/api/csosn/${code}`);
                    const data = await response.json();
                    cache.csosn[code] = data;
                    salvarCache(cache); // Salva o cache atualizado

                    document.getElementById('csosn-description').value = data.descricao || 'Não encontrado';
                    document.getElementById('csosn-type').value = data.tipo || 'Não encontrado';
                } catch (error) {
                    console.error('Erro ao buscar CSOSN:', error);
                    document.getElementById('csosn-description').value = 'Erro ao buscar';
                    document.getElementById('csosn-type').value = 'Erro ao buscar';
                }
            }

            // Função para consultar NCM
            async function searchNCM(event) {
                event.stopPropagation();
                const code = document.getElementById('ncm-code').value;
                if (!code) {
                    alert("Por favor, insira um código NCM.");
                    return;
                }

                if (cache.ncm[code]) {
                    const data = cache.ncm[code];
                    document.getElementById('ncm-descricao').value = data.Descricao || 'Não encontrado';
                    document.getElementById('ncm-ano-ato-ini').value = data.Ano_Ato_Ini || 'Não encontrado';
                    document.getElementById('ncm-numero-ato-ini').value = data.Numero_Ato_Ini || 'Não encontrado';
                    document.getElementById('ncm-tipo-ato-ini').value = data.Tipo_Ato_Ini || 'Não encontrado';
                    document.getElementById('ncm-data-inicio').value = new Date(data.Data_Inicio).toLocaleDateString() || 'Não encontrado';
                    document.getElementById('ncm-data-fim').value = new Date(data.Data_Fim).toLocaleDateString() || 'Não encontrado';
                    return;
                }

                const button = document.querySelector('.search-button');
                button.classList.add('loading');

                try {
                    const response = await fetch(`https://apidadostributarios.onrender.com/api/ncm/${code}`);
                    if (!response.ok) throw new Error(`Erro na requisição: ${response.statusText}`);

                    const data = await response.json();
                    cache.ncm[code] = data;
                    salvarCache(cache); // Salva o cache atualizado

                    document.getElementById('ncm-descricao').value = data.Descricao || 'Não encontrado';
                    document.getElementById('ncm-ano-ato-ini').value = data.Ano_Ato_Ini || 'Não encontrado';
                    document.getElementById('ncm-numero-ato-ini').value = data.Numero_Ato_Ini || 'Não encontrado';
                    document.getElementById('ncm-tipo-ato-ini').value = data.Tipo_Ato_Ini || 'Não encontrado';
                    document.getElementById('ncm-data-inicio').value = new Date(data.Data_Inicio).toLocaleDateString() || 'Não encontrado';
                    document.getElementById('ncm-data-fim').value = new Date(data.Data_Fim).toLocaleDateString() || 'Não encontrado';
                } catch (error) {
                    console.error('Erro ao buscar NCM:', error);
                    alert('Erro ao consultar NCM. Verifique o código e tente novamente.');
                } finally {
                    button.classList.remove('loading');
                }
            }

            // Função para consultar CNPJ
            async function searchCNPJ(event) {
                event.stopPropagation();
                const cnpj = document.getElementById('cnpj-code').value;
                if (!cnpj) return;

                if (cache.cnpj[cnpj]) {
                    const empresa = cache.cnpj[cnpj];
                    document.getElementById('cnpj-fantasia').value = empresa.fantasia || 'Não disponível';
                    document.getElementById('cnpj-razao-social').value = empresa.nome || 'Não disponível';
                    document.getElementById('cnpj-capital-social').value = `R$ ${empresa.capital_social}` || 'Não disponível';
                    document.getElementById('cnpj-abertura').value = empresa.abertura || 'Não disponível';
                    document.getElementById('cnpj-telefone').value = empresa.telefone || 'Não disponível';
                    document.getElementById('cnpj-atividade-principal').value = empresa.atividade_principal[0]?.text || 'Não disponível';
                    document.getElementById('cnpj-email').value = empresa.email || 'Não disponível';
                    document.getElementById('cnpj-endereco').value = `${empresa.logradouro || ''}, ${empresa.numero || ''} - ${empresa.bairro || ''} - ${empresa.municipio || ''} - ${empresa.uf || ''} - CEP: ${empresa.cep || ''}`;
                    return;
                }

                try {
                    const apiUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.receitaws.com.br/v1/cnpj/${cnpj}`)}`;
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    const empresa = JSON.parse(data.contents);

                    if (empresa.status === "ERROR") {
                        alert(`Erro: ${empresa.message}`);
                        return;
                    }

                    cache.cnpj[cnpj] = empresa;
                    salvarCache(cache); // Salva o cache atualizado

                    document.getElementById('cnpj-fantasia').value = empresa.fantasia || 'Não disponível';
                    document.getElementById('cnpj-razao-social').value = empresa.nome || 'Não disponível';
                    document.getElementById('cnpj-capital-social').value = `R$ ${empresa.capital_social}` || 'Não disponível';
                    document.getElementById('cnpj-abertura').value = empresa.abertura || 'Não disponível';
                    document.getElementById('cnpj-telefone').value = empresa.telefone || 'Não disponível';
                    document.getElementById('cnpj-atividade-principal').value = empresa.atividade_principal[0]?.text || 'Não disponível';
                    document.getElementById('cnpj-email').value = empresa.email || 'Não disponível';
                    document.getElementById('cnpj-endereco').value = `${empresa.logradouro || ''}, ${empresa.numero || ''} - ${empresa.bairro || ''} - ${empresa.municipio || ''} - ${empresa.uf || ''} - CEP: ${empresa.cep || ''}`;
                } catch (error) {
                    console.error('Erro ao buscar CNPJ:', error);
                    alert('Erro ao consultar CNPJ. Tente novamente.');
                }
            }

            // Adiciona event listeners aos cards
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', (event) => expandCard(event, card));
            });

            // Adiciona event listeners aos botões de consulta
            document.querySelectorAll('.search-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const action = button.getAttribute('data-action');
                    if (action === 'searchCFOP') searchCFOP(event);
                    if (action === 'searchCST') searchCST(event);
                    if (action === 'searchCSOSN') searchCSOSN(event);
                    if (action === 'searchNCM') searchNCM(event);
                    if (action === 'searchCNPJ') searchCNPJ(event);
                });
            });
        })();
    </script>
</body>
</html>