<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários</title>
    <style>
        /* Limita a altura da tabela e adiciona scroll */
        .tabela-container {
            max-height: 70vh; /* 70% da altura da tela */
            overflow-y: auto; /* Adiciona scroll vertical */
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* Estilo da barra de rolagem */
        .tabela-container::-webkit-scrollbar {
            width: 8px; /* Largura da barra de rolagem */
        }

        .tabela-container::-webkit-scrollbar-track {
            background: var(--background); /* Cor de fundo da barra */
            border-radius: 10px;
        }

        .tabela-container::-webkit-scrollbar-thumb {
            background: #6C63FF; /* Cor da barra de rolagem */
            border-radius: 10px;
        }

        .tabela-container::-webkit-scrollbar-thumb:hover {
            background: #5551C8; /* Cor da barra ao passar o mouse */
        }

        .tabela-usuarios {
            width: 100%;
            border-collapse: collapse;
        }

        .tabela-usuarios th,
        .tabela-usuarios td {
            padding: 12px; /* Padding original */
            text-align: left;
            border-bottom: 1px solid #ccc;
        }

        .tabela-usuarios th {
            background-color: #6C63FF;
            color: white;
            cursor: pointer;
            position: sticky;
            top: 0; /* Fixa o cabeçalho no topo durante a rolagem */
            z-index: 1; /* Garante que o cabeçalho fique acima do conteúdo */
        }

        .tabela-usuarios tr:hover {
            background-color: rgba(108, 99, 255, 0.1);
        }

        .btn-acao {
            padding: 6px 12px; /* Botões no tamanho original */
            background: #6C63FF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 14px;
        }

        .btn-acao:hover {
            background: #5551C8;
        }

        /* Estilo da barra de pesquisa */
        .barra-pesquisa {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            width: 300px; /* Largura menor */
        }

        #campo-pesquisa {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            outline: none;
            background: var(--input-bg);
            color: var(--input-text-color);
            font-size: 14px;
        }

        #botao-pesquisar {
            padding: 8px 12px;
            background: #6C63FF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #botao-pesquisar:hover {
            background: #5551C8;
        }

        /* Contador de usuários */
        .contador-usuarios {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            text-align: right; /* Alinha o contador à direita */
        }
    </style>
</head>
<body>
    <h3>Listagem de Usuários</h3>
    <div class="barra-pesquisa">
        <input type="text" id="campo-pesquisa" placeholder="Pesquisar por ID, Nome, Email, Tipo, Telefone ou CNPJ...">
        <button id="botao-pesquisar">🔍</button>
    </div>
    <div class="tabela-container">
        <table class="tabela-usuarios">
            <thead>
                <tr>
                    <th data-coluna="id">ID</th>
                    <th data-coluna="nome">Nome Completo</th>
                    <th data-coluna="email">Email</th>
                    <th data-coluna="pessoa">Tipo</th>
                    <th data-coluna="telefone">Telefone</th>
                    <th data-coluna="cnpj">CNPJ</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="usuarios-body">
                <!-- Dados dos usuários serão carregados aqui -->
            </tbody>
        </table>
    </div>
    <div class="contador-usuarios" id="contador-usuarios">
        Total de usuários: <span id="total-usuarios">0</span>
    </div>

    <script>
        (function () {
            let usuarios = []; // Armazena os dados dos usuários
            let ordenacao = { coluna: null, ordem: 'asc' }; // Controla a ordenação

            // Função para carregar os usuários da API
            async function carregarUsuarios() {
                const tbody = document.getElementById('usuarios-body');
                tbody.innerHTML = '<tr><td colspan="7">Carregando usuários...</td></tr>';

                try {
                    const response = await fetch('https://apiconsultausuario.onrender.com/api/users');
                    if (!response.ok) throw new Error('Erro ao carregar usuários');

                    usuarios = await response.json();
                    console.log('Dados da API:', usuarios);

                    // Atualiza a tabela com os dados
                    atualizarTabela(usuarios);
                    atualizarContador(usuarios.length); // Atualiza o contador de usuários
                } catch (error) {
                    console.error('Erro ao carregar usuários:', error);
                    tbody.innerHTML = '<tr><td colspan="7">Erro ao carregar usuários. Tente novamente mais tarde.</td></tr>';
                }
            }

            // Função para atualizar a tabela com os dados
            function atualizarTabela(dados) {
                const tbody = document.getElementById('usuarios-body');
                tbody.innerHTML = '';

                if (dados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">Nenhum usuário encontrado.</td></tr>';
                    return;
                }

                dados.forEach(usuario => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${usuario.id}</td>
                        <td>${usuario.nome} ${usuario.sobrenome || ''}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.pessoa || 'N/A'}</td>
                        <td>${usuario.telefone || 'N/A'}</td>
                        <td>${usuario.cnpj || 'N/A'}</td>
                        <td>
                            <button class="btn-acao" onclick="editarUsuario('${usuario._id}')">Editar</button>
                            <button class="btn-acao" onclick="excluirUsuario('${usuario._id}')">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Função para atualizar o contador de usuários
            function atualizarContador(total) {
                document.getElementById('total-usuarios').textContent = total;
            }

            // Função para ordenar os dados
            function ordenar(coluna) {
                if (ordenacao.coluna === coluna) {
                    // Alterna entre ascendente e descendente
                    ordenacao.ordem = ordenacao.ordem === 'asc' ? 'desc' : 'asc';
                } else {
                    // Define a nova coluna e ordem padrão como ascendente
                    ordenacao.coluna = coluna;
                    ordenacao.ordem = 'asc';
                }

                // Ordena os dados
                const dadosOrdenados = usuarios.sort((a, b) => {
                    const valorA = a[coluna] || '';
                    const valorB = b[coluna] || '';

                    if (valorA < valorB) return ordenacao.ordem === 'asc' ? -1 : 1;
                    if (valorA > valorB) return ordenacao.ordem === 'asc' ? 1 : -1;
                    return 0;
                });

                // Atualiza a tabela com os dados ordenados
                atualizarTabela(dadosOrdenados);
            }

            // Função para filtrar os usuários
            function filtrarUsuarios() {
                const termo = document.getElementById('campo-pesquisa').value.toLowerCase();

                const usuariosFiltrados = usuarios.filter(usuario => {
                    return (
                        (usuario.id?.toString() || '').includes(termo) ||
                        ((usuario.nome + ' ' + (usuario.sobrenome || '')).toLowerCase().includes(termo)) ||
                        (usuario.email?.toLowerCase() || '').includes(termo) ||
                        (usuario.pessoa?.toLowerCase() || '').includes(termo) ||
                        (usuario.telefone?.toString() || '').includes(termo) ||
                        (usuario.cnpj?.toString() || '').includes(termo)
                    );
                });

                // Atualiza a tabela com os resultados filtrados
                atualizarTabela(usuariosFiltrados);
                atualizarContador(usuariosFiltrados.length); // Atualiza o contador de usuários
            }

            // Adiciona eventos de clique aos cabeçalhos da tabela
            document.querySelectorAll('.tabela-usuarios th').forEach(th => {
                th.addEventListener('click', () => {
                    const coluna = th.getAttribute('data-coluna');
                    if (coluna) ordenar(coluna);
                });
            });

            // Adiciona evento de clique ao botão de pesquisa
            document.getElementById('botao-pesquisar').addEventListener('click', filtrarUsuarios);

            // Adiciona evento de "Enter" no campo de pesquisa
            document.getElementById('campo-pesquisa').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    filtrarUsuarios();
                }
            });

            // Carrega os usuários ao carregar o módulo
            carregarUsuarios();

            // Função para editar um usuário (exemplo)
            function editarUsuario(id) {
                alert(`Editar usuário com ID: ${id}`);
            }

            // Função para excluir um usuário (exemplo)
            function excluirUsuario(id) {
                if (confirm(`Tem certeza que deseja excluir o usuário com ID: ${id}?`)) {
                    alert(`Usuário com ID: ${id} excluído!`);
                }
            }
        })();
    </script>
</body>
</html>